# Сетевые дампы

## `lan_success.pcap`

- **Сценарий:** оба клиента находятся в одной локальной сети (`192.168.16.0/24`). STUN/Rendezvous-сервер слушает на `192.168.16.100:3478`.
- **Как получить файл:** он уже лежит в репозитории (`dumps/lan_success.pcap`). Можно дополнительно воспроизвести запись командой
  `sudo tcpdump -i eth0 -w dumps/lan_success.pcap '(host 192.168.16.2 or host 192.168.16.3) and udp'`.
- **Как анализировать:** `wireshark dumps/lan_success.pcap`, либо `tcpdump -nr dumps/lan_success.pcap -vv`.

### Пакеты внутри файла

| № | Отправитель → Получатель | Содержимое | Пояснение |
|---|--------------------------|------------|-----------|
| 1 | `192.168.16.2:40000 → 192.168.16.100:3478` | `0x01` | Клиент отправляет `STUN_REQUEST`, чтобы узнать свой внешний адрес. |
| 2 | `192.168.16.100:3478 → 192.168.16.2:40000` | `0x02 + <ip><port>` | Сервер отвечает `STUN_RESPONSE` и сообщает клиенту его внешний адрес/порт. |
| 3 | `192.168.16.2:40000 → 192.168.16.3:50000` | `0x07 "Hi from peer1"` | Первый hole punch‑пакет (`P2P_MESSAGE`) в сторону второго клиента. |
| 4 | `192.168.16.3:50000 → 192.168.16.2:40000` | `0x07 "Hi from peer2"` | Ответный `P2P_MESSAGE` — подтверждает, что прямой канал установлен. |

### Как это соотносится с логами приложения

1. Клиенты выводят:
   ```
   Step 1: Discovering external address via STUN...
   External address discovered: 192.168.16.X:YYYY
   ```
   Это соответствует пакетам 1–2.
2. После обмена `PEER_INFO` начинается `performHolePunching()`. В логах видны строки вида:
   ```
   → Sent hole punch 0 to 192.168.16.3:50000
   ```
   Это пакет №3.
3. Как только второй клиент ответил, оба видят:
   ```
   ✓ Received from peer 192.168.16.2:40000: Hole punch 0 from ...
   ```
   Это пакет №4 и означает успешное установление соединения.

### Ключевые выводы по дампу

- В LAN-сценарии клиенты напрямую используют локальные адреса — NAT уже не участвует.
- Благодаря принудительному IPv4-сокету и приоритету локальных кандидатов пакеты приходят без задержек.
- Полный цикл (STUN → регистрация → hole punch → сообщения) укладывается в четыре UDP‑пакета.

